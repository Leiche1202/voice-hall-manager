# 语音厅管理系统 - 免费部署方案实施步骤

## 概述

本文档提供了将语音厅管理系统部署到免费平台的具体实施步骤。基于前面的免费部署指南，我们选择了最适合当前项目的部署方案，并提供了详细的操作指导。

## 选定的部署方案

经过评估，我们选择以下免费方案部署语音厅管理系统：

- **前端部署**：Vercel（提供永久免费计划，自动HTTPS，全球CDN）
- **后端API**：Vercel Serverless Functions（与前端集成，简化部署流程）
- **数据存储**：Firebase Firestore（提供免费的NoSQL数据库服务，足够当前需求）

## 实施步骤

### 1. 准备工作

#### 1.1 注册必要账号

1. 注册GitHub账号（如果没有）：https://github.com/
2. 使用GitHub账号注册Vercel：https://vercel.com/
3. 注册Firebase账号：https://firebase.google.com/

#### 1.2 创建GitHub仓库

1. 在GitHub创建新仓库：`voice-hall-management`
2. 将本地代码推送到GitHub仓库：

```bash
git init
git add .
git commit -m "Initial commit"
git remote add origin https://github.com/你的用户名/voice-hall-management.git
git push -u origin main
```

### 2. 配置Firebase

#### 2.1 创建Firebase项目

1. 登录Firebase控制台：https://console.firebase.google.com/
2. 点击「创建项目」，输入项目名称：`voice-hall-management`
3. 根据提示完成项目创建

#### 2.2 启用Firestore数据库

1. 在Firebase控制台左侧菜单选择「Firestore Database」
2. 点击「创建数据库」
3. 选择「测试模式」开始（后续可以根据需要调整安全规则）
4. 选择离您最近的数据中心位置

#### 2.3 创建Web应用

1. 在Firebase控制台点击「项目设置」（齿轮图标）
2. 在「应用」标签页，点击「添加应用」，选择Web图标
3. 输入应用名称：`voice-hall-web`，点击「注册应用」
4. 保存显示的Firebase配置信息（apiKey, authDomain等）

### 3. 集成Firebase到项目

#### 3.1 安装Firebase SDK

```bash
npm install firebase
```

#### 3.2 创建Firebase配置文件

创建文件：`src/lib/firebase.js`

```javascript
import { initializeApp } from 'firebase/app';
import { getFirestore } from 'firebase/firestore';
import { getAuth } from 'firebase/auth';

const firebaseConfig = {
  apiKey: "YOUR_API_KEY",
  authDomain: "YOUR_PROJECT_ID.firebaseapp.com",
  projectId: "YOUR_PROJECT_ID",
  storageBucket: "YOUR_PROJECT_ID.appspot.com",
  messagingSenderId: "YOUR_MESSAGING_SENDER_ID",
  appId: "YOUR_APP_ID"
};

// 初始化Firebase
const app = initializeApp(firebaseConfig);

// 初始化服务
const db = getFirestore(app);
const auth = getAuth(app);

export { db, auth };
```

#### 3.3 创建数据服务

创建文件：`src/services/scheduleService.js`

```javascript
import { collection, addDoc, getDocs, query, where, doc, updateDoc, deleteDoc, Timestamp } from 'firebase/firestore';
import { db } from '../lib/firebase';

// 添加档表
export async function addSchedule(scheduleData) {
  try {
    // 转换日期为Firestore Timestamp
    const data = {
      ...scheduleData,
      date: Timestamp.fromDate(new Date(scheduleData.date)),
      createdAt: Timestamp.now(),
      updatedAt: Timestamp.now()
    };
    
    const docRef = await addDoc(collection(db, "schedules"), data);
    return docRef.id;
  } catch (error) {
    console.error("Error adding schedule: ", error);
    throw error;
  }
}

// 获取指定日期的档表
export async function getScheduleByDate(dateString) {
  try {
    const date = new Date(dateString);
    // 创建日期范围（当天开始到结束）
    const startOfDay = new Date(date.setHours(0, 0, 0, 0));
    const endOfDay = new Date(date.setHours(23, 59, 59, 999));
    
    const q = query(
      collection(db, "schedules"),
      where("date", ">", Timestamp.fromDate(startOfDay)),
      where("date", "<", Timestamp.fromDate(endOfDay))
    );
    
    const querySnapshot = await getDocs(q);
    if (querySnapshot.empty) {
      return null;
    }
    
    // 通常一天只有一个档表，取第一个
    const doc = querySnapshot.docs[0];
    return {
      id: doc.id,
      ...doc.data(),
      // 转换Timestamp为JS Date
      date: doc.data().date.toDate(),
      createdAt: doc.data().createdAt?.toDate(),
      updatedAt: doc.data().updatedAt?.toDate()
    };
  } catch (error) {
    console.error("Error getting schedule: ", error);
    throw error;
  }
}

// 更新档表
export async function updateSchedule(id, scheduleData) {
  try {
    const scheduleRef = doc(db, "schedules", id);
    await updateDoc(scheduleRef, {
      ...scheduleData,
      updatedAt: Timestamp.now()
    });
    return true;
  } catch (error) {
    console.error("Error updating schedule: ", error);
    throw error;
  }
}

// 删除档表
export async function deleteSchedule(id) {
  try {
    await deleteDoc(doc(db, "schedules", id));
    return true;
  } catch (error) {
    console.error("Error deleting schedule: ", error);
    throw error;
  }
}
```

创建文件：`src/services/authService.js`

```javascript
import { signInWithEmailAndPassword, signOut, createUserWithEmailAndPassword } from 'firebase/auth';
import { doc, setDoc, getDoc, collection, query, where, getDocs } from 'firebase/firestore';
import { auth, db } from '../lib/firebase';

// 模拟登录（开发阶段使用）
export async function mockLogin(username, password) {
  if (username === '1' && password === '111') {
    return {
      user: {
        id: '1',
        username: username,
        role: 'admin',
        displayName: '系统管理员'
      },
      token: 'mock-token-admin'
    };
  } else if (username === '2' && password === '111') {
    return {
      user: {
        id: '2',
        username: username,
        role: 'host',
        displayName: '主持人'
      },
      token: 'mock-token-host'
    };
  } else {
    throw new Error('用户名或密码错误');
  }
}

// 实际登录（生产环境使用）
export async function login(email, password) {
  try {
    const userCredential = await signInWithEmailAndPassword(auth, email, password);
    const user = userCredential.user;
    
    // 获取用户附加信息
    const userDoc = await getDoc(doc(db, "users", user.uid));
    if (userDoc.exists()) {
      return {
        user: {
          id: user.uid,
          email: user.email,
          ...userDoc.data()
        },
        token: await user.getIdToken()
      };
    } else {
      throw new Error('用户信息不存在');
    }
  } catch (error) {
    console.error("Login error:", error);
    throw error;
  }
}

// 退出登录
export async function logout() {
  try {
    await signOut(auth);
    return true;
  } catch (error) {
    console.error("Logout error:", error);
    throw error;
  }
}
```

### 4. 修改前端代码适配Firebase

#### 4.1 创建API上下文

创建文件：`src/contexts/ApiContext.jsx`

```jsx
import React, { createContext, useContext, useState, useEffect } from 'react';
import { mockLogin } from '../services/authService';
import { getScheduleByDate, addSchedule, updateSchedule } from '../services/scheduleService';

const ApiContext = createContext();

export function useApi() {
  return useContext(ApiContext);
}

export function ApiProvider({ children }) {
  const [currentUser, setCurrentUser] = useState(null);
  const [loading, setLoading] = useState(true);
  
  // 检查本地存储的用户信息
  useEffect(() => {
    const storedUser = localStorage.getItem('currentUser');
    if (storedUser) {
      setCurrentUser(JSON.parse(storedUser));
    }
    setLoading(false);
  }, []);
  
  // 登录函数
  const login = async (username, password) => {
    try {
      // 使用模拟登录（开发阶段）
      const result = await mockLogin(username, password);
      setCurrentUser(result.user);
      localStorage.setItem('currentUser', JSON.stringify(result.user));
      return result.user;
    } catch (error) {
      console.error("Login error:", error);
      throw error;
    }
  };
  
  // 退出登录
  const logout = () => {
    setCurrentUser(null);
    localStorage.removeItem('currentUser');
  };
  
  // 获取档表
  const getSchedule = async (date) => {
    try {
      const dateStr = date instanceof Date ? date.toISOString().split('T')[0] : date;
      const schedule = await getScheduleByDate(dateStr);
      
      // 如果没有找到档表，创建一个空的
      if (!schedule) {
        return {
          date: new Date(dateStr),
          details: Array.from({ length: 24 }, () => ({ 备档: '', 主档: '', 陪档: '' }))
        };
      }
      
      return schedule;
    } catch (error) {
      console.error("Get schedule error:", error);
      throw error;
    }
  };
  
  // 保存档表
  const saveSchedule = async (scheduleData) => {
    try {
      if (scheduleData.id) {
        // 更新现有档表
        await updateSchedule(scheduleData.id, scheduleData);
      } else {
        // 创建新档表
        await addSchedule(scheduleData);
      }
      return true;
    } catch (error) {
      console.error("Save schedule error:", error);
      throw error;
    }
  };
  
  const value = {
    currentUser,
    login,
    logout,
    getSchedule,
    saveSchedule
  };
  
  return (
    <ApiContext.Provider value={value}>
      {!loading && children}
    </ApiContext.Provider>
  );
}
```

#### 4.2 修改App.jsx使用API上下文

修改`src/App.jsx`，添加API上下文提供者：

```jsx
import { ApiProvider } from './contexts/ApiContext';

// 应用主入口
function App() {
  return (
    <ApiProvider>
      <Router>
        <AnimatePresence mode='wait'>
          <Routes>
            <Route path="/" element={<LoginPage />} />
            <Route path="/hall-admin-dashboard" element={<HallAdminDashboardWrapper />} />
            <Route path="/host-dashboard" element={<HostDashboard />} />
            <Route path="/schedule-management" element={<ScheduleManagement />} />
            <Route path="/salary-management" element={<SalaryManagement />} />
            <Route path="*" element={<Navigate to="/" />} />
          </Routes>
        </AnimatePresence>
      </Router>
    </ApiProvider>
  );
}
```

#### 4.3 修改登录页面使用API上下文

修改`LoginPage`组件：

```jsx
const LoginPage = () => {
  const [username, setUsername] = React.useState('');
  const [password, setPassword] = React.useState('');
  const [error, setError] = React.useState('');
  const navigate = useNavigate();
  const [loading, setLoading] = React.useState(false);
  const { login } = useApi(); // 使用API上下文

  const handleLogin = async () => {
    setLoading(true);
    try {
      const user = await login(username, password);
      if (user.role === 'admin') {
        navigate('/hall-admin-dashboard');
      } else if (user.role === 'host') {
        navigate('/host-dashboard');
      }
    } catch (error) {
      setError('用户名或密码错误');
    } finally {
      setLoading(false);
    }
  };
  
  // 其余代码保持不变...
};
```

#### 4.4 修改档表管理页面使用API上下文

修改`ScheduleManagement`组件：

```jsx
const ScheduleManagement = () => {
  const navigate = useNavigate();
  const [schedule, setSchedule] = React.useState(() =>
    Array.from({ length: 24 }, () => ({ 备档: '', 主档: '', 陪档: '' }))
  );
  const [scheduleId, setScheduleId] = React.useState(null);
  const [selecting, setSelecting] = React.useState(null);
  const [isSaving, setIsSaving] = React.useState(false);
  const [isLoading, setIsLoading] = React.useState(true);
  const { getSchedule, saveSchedule } = useApi(); // 使用API上下文
  
  // 加载档表数据
  React.useEffect(() => {
    const loadSchedule = async () => {
      try {
        const today = new Date().toISOString().split('T')[0];
        const result = await getSchedule(today);
        if (result) {
          setScheduleId(result.id);
          setSchedule(result.details || []);
        }
      } catch (error) {
        console.error("Failed to load schedule:", error);
      } finally {
        setIsLoading(false);
      }
    };
    
    loadSchedule();
  }, [getSchedule]);

  // 保存档表
  const handleSave = async () => {
    setIsSaving(true);
    try {
      const today = new Date().toISOString().split('T')[0];
      await saveSchedule({
        id: scheduleId,
        date: today,
        details: schedule,
        status: 'published'
      });
      alert('档表已保存！');
    } catch (error) {
      console.error("Failed to save schedule:", error);
      alert('保存失败，请重试！');
    } finally {
      setIsSaving(false);
    }
  };
  
  // 其余代码保持不变...
};
```

### 5. 部署到Vercel

#### 5.1 安装Vercel CLI

```bash
npm install -g vercel
```

#### 5.2 登录Vercel

```bash
vercel login
```

#### 5.3 部署应用

```bash
# 在项目根目录执行
vercel
```

按照提示完成配置：

- 是否链接到现有项目？选择「否」
- 项目名称：voice-hall-management
- 构建命令：npm run build
- 输出目录：dist
- 开发命令：npm run dev

#### 5.4 设置环境变量

在Vercel控制台：

1. 选择您的项目
2. 点击「Settings」标签
3. 点击「Environment Variables」
4. 添加Firebase配置信息作为环境变量

#### 5.5 配置自定义域名（可选）

如果您有自己的域名：

1. 在Vercel控制台，选择您的项目
2. 点击「Settings」标签
3. 点击「Domains」
4. 添加您的域名并按照指示配置DNS

### 6. 测试部署

1. 访问Vercel提供的URL（如`https://voice-hall-management.vercel.app`）
2. 测试登录功能（用户名：1，密码：111）
3. 测试档表管理功能
4. 验证数据是否正确保存到Firebase

## 后续优化

### 1. 实现真实的用户认证

替换模拟登录为Firebase Authentication：

```javascript
// 在authService.js中实现
export async function registerUser(email, password, userData) {
  try {
    const userCredential = await createUserWithEmailAndPassword(auth, email, password);
    const user = userCredential.user;
    
    // 保存用户附加信息到Firestore
    await setDoc(doc(db, "users", user.uid), {
      ...userData,
      createdAt: new Date()
    });
    
    return user;
  } catch (error) {
    console.error("Registration error:", error);
    throw error;
  }
}
```

### 2. 添加离线支持

配置Firebase离线持久化：

```javascript
// 在firebase.js中添加
import { enableIndexedDbPersistence } from 'firebase/firestore';

// 启用离线持久化
enableIndexedDbPersistence(db)
  .catch((err) => {
    if (err.code == 'failed-precondition') {
      console.log('Multiple tabs open, persistence can only be enabled in one tab at a a time.');
    } else if (err.code == 'unimplemented') {
      console.log('The current browser does not support all of the features required to enable persistence');
    }
  });
```

### 3. 添加数据备份功能

创建定期备份Firebase数据的Cloud Function（需要升级到Blaze计划）。

## 总结

通过以上步骤，我们成功将语音厅管理系统部署到了完全免费的平台上：

- 前端应用托管在Vercel，享受全球CDN和自动HTTPS
- 使用Firebase Firestore作为数据库，支持实时数据同步
- 实现了基本的用户认证和数据管理功能

这种部署方案适合个人开发者或小型团队，可以在不产生基础设施成本的情况下快速上线和验证产品。随着用户量增长，可以考虑升级到付费计划或迁移到其他平台。