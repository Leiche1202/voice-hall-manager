# 语音厅管理系统 - 腾讯云部署指南

本文档提供了将语音厅管理系统部署到腾讯云的详细步骤和最佳实践。

## 目录

1. [准备工作](#准备工作)
2. [构建应用](#构建应用)
3. [腾讯云服务器配置](#腾讯云服务器配置)
4. [数据库配置](#数据库配置)
5. [应用部署](#应用部署)
6. [域名和HTTPS配置](#域名和https配置)
7. [持续集成/持续部署](#持续集成持续部署)
8. [监控和维护](#监控和维护)

## 准备工作

### 本地环境准备

1. 确保本地开发环境已完成开发和测试
2. 确保Git仓库已更新最新代码
3. 安装腾讯云CLI工具(可选)

### 腾讯云账号准备

1. 注册腾讯云账号：https://cloud.tencent.com/
2. 完成实名认证
3. 充值足够的账户余额

## 构建应用

在部署前，需要先构建生产环境的应用包：

```bash
# 安装依赖
npm install

# 构建生产环境应用
npm run build
```

构建完成后，会在`dist`目录生成可部署的静态文件。

## 腾讯云服务器配置

### 购买轻量应用服务器

1. 登录腾讯云控制台
2. 选择「轻量应用服务器」产品
3. 选择配置：
   - 地域：选择离目标用户最近的地域
   - 镜像：选择「应用镜像」中的「Node.js」
   - 实例套餐：根据预期流量选择（建议至少2核4G）
   - 购买时长：根据预算选择

### 服务器初始化

1. 服务器创建完成后，使用SSH连接到服务器

```bash
ssh root@your_server_ip
```

2. 更新系统并安装必要软件

```bash
apt update && apt upgrade -y
apt install -y git nginx
```

3. 配置Node.js环境（如果使用Node.js镜像，可能已预装）

```bash
# 检查Node.js版本
node -v

# 如需安装特定版本
curl -sL https://deb.nodesource.com/setup_16.x | bash -
apt install -y nodejs
```

## 数据库配置

### 创建腾讯云数据库

1. 在腾讯云控制台选择「云数据库 MySQL」
2. 创建数据库实例：
   - 选择与服务器相同的地域
   - 根据需求选择配置
   - 设置安全的密码

3. 创建数据库和用户

```sql
CREATE DATABASE voice_hall_management;
CREATE USER 'voice_hall_user'@'%' IDENTIFIED BY 'your_secure_password';
GRANT ALL PRIVILEGES ON voice_hall_management.* TO 'voice_hall_user'@'%';
FLUSH PRIVILEGES;
```

4. 配置数据库安全组，允许服务器IP访问

## 应用部署

### 部署前端应用

1. 在服务器上创建应用目录

```bash
mkdir -p /var/www/voice-hall
```

2. 将本地构建好的`dist`目录内容上传到服务器

```bash
# 本地执行
scp -r ./dist/* root@your_server_ip:/var/www/voice-hall/
```

3. 配置Nginx作为静态文件服务器和API代理

```bash
# 创建Nginx配置文件
cat > /etc/nginx/sites-available/voice-hall.conf << 'EOL'
server {
    listen 80;
    server_name your_domain.com;

    root /var/www/voice-hall;
    index index.html;

    location / {
        try_files $uri $uri/ /index.html;
    }

    # 如果有后端API，添加代理配置
    location /api {
        proxy_pass http://localhost:3000;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_cache_bypass $http_upgrade;
    }
}
EOL

# 启用站点配置
ln -s /etc/nginx/sites-available/voice-hall.conf /etc/nginx/sites-enabled/

# 测试Nginx配置
nginx -t

# 重启Nginx
systemctl restart nginx
```

### 部署后端API（如果需要）

1. 在服务器上克隆后端代码仓库

```bash
git clone your_backend_repo_url /var/www/voice-hall-api
cd /var/www/voice-hall-api
```

2. 安装依赖并构建

```bash
npm install
npm run build # 如果需要构建
```

3. 使用PM2管理Node.js应用

```bash
# 安装PM2
npm install -g pm2

# 启动应用
pm2 start npm -- start

# 设置开机自启
pm2 startup
pm2 save
```

## 域名和HTTPS配置

### 域名配置

1. 在腾讯云购买域名或使用已有域名
2. 在DNS设置中添加A记录，指向服务器IP

### HTTPS配置

1. 安装Certbot

```bash
apt install -y certbot python3-certbot-nginx
```

2. 获取并配置SSL证书

```bash
certbot --nginx -d your_domain.com
```

3. 设置自动续期

```bash
certbot renew --dry-run
```

## 持续集成/持续部署

### 使用GitHub Actions自动部署

1. 在项目根目录创建`.github/workflows/deploy.yml`文件

```yaml
name: Deploy to Tencent Cloud

on:
  push:
    branches: [ main ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v2
    
    - name: Setup Node.js
      uses: actions/setup-node@v2
      with:
        node-version: '16'
        
    - name: Install Dependencies
      run: npm install
      
    - name: Build
      run: npm run build
      
    - name: Deploy to Server
      uses: appleboy/scp-action@master
      with:
        host: ${{ secrets.HOST }}
        username: ${{ secrets.USERNAME }}
        key: ${{ secrets.SSH_KEY }}
        source: "dist/"
        target: "/var/www/voice-hall"
        strip_components: 1
```

2. 在GitHub仓库设置中添加Secrets：
   - HOST: 服务器IP
   - USERNAME: SSH用户名
   - SSH_KEY: SSH私钥

## 监控和维护

### 服务器监控

1. 启用腾讯云监控服务
2. 配置告警策略，监控CPU、内存、磁盘使用率

### 日志管理

1. 配置Nginx日志轮转

```bash
cat > /etc/logrotate.d/nginx << 'EOL'
/var/log/nginx/*.log {
    daily
    missingok
    rotate 14
    compress
    delaycompress
    notifempty
    create 0640 www-data adm
    sharedscripts
    postrotate
        [ -s /run/nginx.pid ] && kill -USR1 `cat /run/nginx.pid`
    endscript
}
EOL
```

2. 使用PM2日志管理（如果使用Node.js后端）

```bash
# 查看日志
pm2 logs

# 设置日志轮转
pm2 install pm2-logrotate
pm2 set pm2-logrotate:max_size 10M
pm2 set pm2-logrotate:retain 30
```

### 定期备份

1. 设置数据库自动备份

```bash
# 创建备份脚本
cat > /root/backup_db.sh << 'EOL'
#!/bin/bash
BACKUP_DIR="/root/backups"
DATETIME=$(date +"%Y%m%d_%H%M%S")
MYSQL_USER="voice_hall_user"
MYSQL_PASSWORD="your_secure_password"
DATABASE="voice_hall_management"

mkdir -p $BACKUP_DIR

mysqldump -u$MYSQL_USER -p$MYSQL_PASSWORD $DATABASE | gzip > $BACKUP_DIR/$DATABASE-$DATETIME.sql.gz

# 删除7天前的备份
find $BACKUP_DIR -name "*.sql.gz" -type f -mtime +7 -delete
EOL

# 添加执行权限
chmod +x /root/backup_db.sh

# 添加到crontab，每天凌晨3点执行
echo "0 3 * * * /root/backup_db.sh" | crontab -
```

## 总结

按照本指南完成部署后，您的语音厅管理系统将在腾讯云上稳定运行。系统采用了Nginx作为前端静态资源服务器，可选配置Node.js后端API，以及MySQL数据库存储数据。

定期检查系统状态、更新安全补丁并进行数据备份，确保系统长期稳定运行。

如有任何问题，请参考腾讯云官方文档或联系技术支持。